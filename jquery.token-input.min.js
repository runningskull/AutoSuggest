/*
 *  tokenInput - by Juan Patten (@runningskull, https://github.com/runningskull/)
 *
 * this plugin is forked from 
 * Drew Wilson's AutoSuggest (https://github.com/drewwilson/autosuggest)
 */(function(a){a.fn.tokenInput=function(b){var c={asHtmlID:!1,selectedItemProp:"value",selectedValuesProp:"value",start:function(){},selectionClick:function(a){},selectionAdded:function(a){},selectionRemoved:function(a){a.remove()}},d=a.extend(c,b);return this.each(function(b){function p(b,c){k.val(k.val()+b[d.selectedValuesProp]+",");var i=a('<li class="as-selection-item" id="as-selection-'+c+'"></li>').click(function(){d.selectionClick.call(this,a(this)),g.children().removeClass("selected"),a(this).addClass("selected")}).mousedown(function(){f=!1}),j=a('<a class="as-close">&times;</a>').click(function(){return k.val(k.val().replace(","+b[d.selectedValuesProp]+",",",")),d.selectionRemoved.call(this,i),f=!0,e.focus(),!1});h.before(i.html(b[d.selectedItemProp]).prepend(j)),d.selectionAdded.call(this,h.prev())}var c;d.asHtmlID?(b=d.asHtmlID,c=b):(b=b+""+Math.floor(Math.random()*100),c="as-input-"+b);var e=a(this),f=!1;d.start.call(this),e.attr("autocomplete","off").addClass("as-input").attr("id",c),e.wrap('<ul class="as-selections" id="as-selections-'+b+'"></ul>').wrap('<li class="as-original" id="as-original-'+b+'"></li>');var g=a("#as-selections-"+b),h=a("#as-original-"+b),i=a('<div class="as-results" id="as-results-'+b+'"></div>').hide(),j=a('<ul class="as-list"></ul>'),k=a('<input type="hidden" class="as-values" name="as_values_'+b+'" id="as-values-'+b+'" />');e.after(k),g.click(function(){f=!0,e.focus()}).mousedown(function(){f=!1}).after(i);var l=null,m="",n=0,o=!1;e.focus(function(){return f&&(a("li.as-selection-item",g).removeClass("blur"),a(this).val()!=""&&(j.css("width",g.outerWidth()),i.show())),f=!0,!0}).blur(function(){f&&(a("li.as-selection-item",g).addClass("blur").removeClass("selected"),i.hide())}).keydown(function(b){lastKeyPressCode=b.keyCode,first_focus=!1;switch(b.keyCode){case 8:if(e.val()==""){var c=k.val().split(",");c=c[c.length-2],g.children().not(h.prev()).removeClass("selected"),h.prev().hasClass("selected")?(k.val(k.val().replace(","+c+",",",")),d.selectionRemoved.call(this,h.prev())):(d.selectionClick.call(this,h.prev()),h.prev().addClass("selected"))}e.val().length==1&&(i.hide(),m="");break;case 9:case 188:o=!0;var f=e.val().replace(/(,)/g,"");if(f!=""&&k.val().search(","+f+",")<0){b.preventDefault();var j={};j[d.selectedItemProp]=f,j[d.selectedValuesProp]=f;var l=a("li",g).length;p(j,"00"+(l+1)),e.val("")}}})})}})(jQuery);